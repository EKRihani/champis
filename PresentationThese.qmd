---
title: "Application de modèles d'apprentissage machine à la classification des macromycètes"
author: "Emir Kaïs RIHANI"
format:
  revealjs:
    #theme: litera
    theme: solarized
    slide-number: true
    embed-resources: true
---

```{r setup, include = FALSE, warning = FALSE}
load("EKR-Champis-Valeurs.RData")
load("EKR-Champis-Iris-Light.RData")
load("EKR-Champis-Intro-Light.RData")
#load("EKR-Champis-Naif-Light.RData")
load("EKR-Champis-AnalyseBi-Light.RData")
#load("EKR-Champis-AnalyseMultiFam-Light.RData")
load("EKR-Champis-AnalyseMultiEsp-Light.RData")
load("EKR-Generateur.RData")
load("EKR-DataSets.RData")
load("EKR-Champis-Outro.RData")

library(ggpubr)
library(tidyverse)
```

# Introduction et objet de l'étude

## Objet de l'étude

-   "Application de modèles d'apprentissage machine à la classification des macromycètes"
    -   Apprentissage machine
    -   Classification
    -   Macromycètes

# Notion de macromycète

## Macromycètes

-   Macro-Mycète = "grand champignon"
-   Le champignon (*mycélium*) est en réalité quasi-invisible et intimement lié à son substrat
-   La partie visible du champignon est le *sporophore*

## Critère de forme

![](Photos/Formes/Craterellus_cornucopioides_2006_jg_1.jpg){fig-align="left" width="32%"} ![](Photos/Formes/Lycoperdon_perlatum_2010_mm_1.jpg){fig-align="center" width="32%"} ![](Photos/Formes/Morchella_esculenta_2007_ov_1.jpg){fig-align="right" width="32%"}

![](Photos/Formes/Pezziza%20spp_2007_go_1.jpg){fig-align="left" width="32%"} ![](Photos/Formes/Pleurotus_ostreatus_2007_ov_1.jpg){fig-align="center" width="32%"} ![](Photos/Formes/Tremella_mesenterica_2006_jg_1.jpg){fig-align="right" width="32%"}

![](Photos/Formes/Phallus_impudicus_2010_dg_1.jpg){.fragment .absolute bottom="40" left="360" height="540"}

::: footer
Source : MycoDB
:::

## Critère de couleur

![](Photos/Couleurs/Amanita_muscaria_2005_ov_2.jpg){fig-align="left" width="32%"} ![](Photos/Couleurs/Entoloma_euchroum_2021_fm_2+.jpg){fig-align="center" width="32%"} ![](Photos/Couleurs/Hygrocybe_psittacinus_2008_jd_1.jpg){fig-align="right" width="32%"}

![](Photos/Couleurs/Phellodon_niger_2013_jg_1.jpg){fig-align="left" width="32%"} ![](Photos/Couleurs/Laccaria_amethystina_1998_dr_1.jpg){fig-align="center" width="32%"} ![](Photos/Couleurs/Hygrocybe_psittacinus_2008_mp_1.jpg){fig-align="right" width="32%"}

::: footer
Source : MycoDB
:::

## Critère de texture

## Critère écologique

- Le champignon fait partie d'un écosystème
   - Hétérotrophie, interactions avec l'environnement
![](EcosystemeChampi.png)

## Caractéristiques du sporophore

![](AnatomieChampis.png)

# Notion de classification

## Classification

-   Classification binaire : 2 classes
    -   Comestible ou non ?
    -   Définition *précise* du critère
-   Classification multiclasse : > 2 classes
    -   Familles
    -   Espèces
    -   Syndromes ?

## Notion de comestibilité

-   La comestibilité se situe sur un continuum :
    -   Excellents comestibles : *Tuber spp.*, *Amanita caesaria*...
    -   Comestibles : *Agaricus arvensis*...
    -   Comestibles cuits : *Morchella spp.*...
    -   Comestibles médiocres : *Boletus felleus*...
    -   Toxiques en grandes quantités : *Tricholoma equestre*...
    -   Toxiques : *Amanita muscaria*...
    -   Mortels : *Amanita phalloides*, *Amanita virosa*...

## Notion de comestibilité

| | C+ | C | CC | C- | T- | T | T+ |
|-|:--:|:-:|:--:|:--:|:--:|:-:|:--:|
| Prudent           | [✓]{style="color:green;"} | [✓]{style="color:green;"} | [✓]{style="color:green;"} |  [✗]{style="color:red;"}  |  [✗]{style="color:red;"}  | [✗]{style="color:red;"} | [✗]{style="color:red;"} |
| Gourmand          | [✓]{style="color:green;"} | [✓]{style="color:green;"} | [✓]{style="color:green;"} |  [✗]{style="color:red;"}  | [✓]{style="color:green;"} | [✗]{style="color:red;"} | [✗]{style="color:red;"} |
| Toxicologue | [✓]{style="color:green;"} | [✓]{style="color:green;"} |  [✗]{style="color:red;"}  | [✓]{style="color:green;"} |  [✗]{style="color:red;"}  | [✗]{style="color:red;"} | [✗]{style="color:red;"} |

-   Critères du "gastronome prudent"
    -   Toxiques et comestibles médiocres : à rejeter
    -   Comestibles cuits : à conserver (morilles !)

# Notion d'apprentissage machine

## Généralités


## Analyse Discriminante Linéaire


## Arbres de classification

## Forêts aléatoires

## Optimisation des modèles
- Indicateur de performance
   - Indice de Youden pondéré ($J_{w} \geq `r Jw_min`$)
      - Indice synthétique pondérant spécificité et sensibilité
      - `r Jw_ratio`x plus grave d'accepter un non-comestible
   - Kappa ($\kappa > 0.80$)
      - Probabilité de prédiction exacte vs hasard
- Exploration de l'espace des hyperparamètres
   - Plans d'expériences

## Plans hypercubiques latins

- Plan d'expérience de type *Space-Filling Design*
   - 1 ligne + 1 colonne = 1 expérience

```{r, dev = "png", dev.args=list(bg="transparent"), fig.height = 3.5, fig.cap = "Carré latin aléatoire (à gauche), optimisé (au milieu), quasi-orthogonal (à droite)"}
ggarrange(
   widths = c(1.05,1,1),
   ncol = 3,
   graphe_LHS + 
   theme(
      panel.background = element_rect(fill = "transparent", color="transparent"),
      plot.background = element_rect(fill = "transparent", color="transparent"),
      legend.background = element_rect(fill="transparent", color="transparent"),
      legend.box.background = element_rect(fill="transparent", color="transparent")
   ),
   graphe_optiLHS + 
   theme(
      panel.background = element_rect(fill = "transparent", color="transparent"),
      plot.background = element_rect(fill = "transparent", color="transparent"),
      legend.background = element_rect(fill="transparent", color="transparent"),
      legend.box.background = element_rect(fill="transparent", color="transparent")
   ),
   graphe_NOHLD + 
   theme(
      panel.background = element_rect(fill = "transparent", color="transparent"),
      plot.background = element_rect(fill = "transparent", color="transparent"),
      legend.background = element_rect(fill="transparent", color="transparent"),
      legend.box.background = element_rect(fill="transparent", color="transparent")
   )
)

```

# Génération du lot de données

## Construction du lot de données

- `r GEN_n_especes` espèces de champignons du Nord de la France
   - 25 critères caractéristiques
      - 22 critères qualitatifs
      - 3 critères quantitatifs
      - Espèce, famille, comestibilité
- `r GEN_n_champis` spécimens par espèce : `r BI_n_champis` champignons

- Tirage aléatoire des critères qualitatifs parmi les critères possibles pour chaque caractéristique et chaque espèce

## Génération des critères quantitatifs

- Critères dimensionnels :
   - Diamètre du chapeau $D_{c}$,
   - Diamètre du pied (stipe) $D_{S}$,
   - Hauteur du pied (stipe) $L_{S}$.
 - Proportionnels, liés à la croissance du champignon $F_{C}$.
$$\left \{
\begin{array}{l}
L_{S} = L_{S_{max}}.F_{C} \\
D_{S} = D_{S_{max}}.F_{C} \\
D_{C} = D_{C_{max}}.F_{C} \\
\end{array}
\right.$$

## Génération des critères quantitatifs : loi bêta
```{r, dev = "png", dev.args=list(bg="transparent")}
lois_beta + 
   theme(
      panel.background = element_rect(fill = "transparent", color="transparent"),
      plot.background = element_rect(fill = "transparent", color="transparent"),
      legend.background = element_rect(fill="transparent", color="transparent"),
      legend.box.background = element_rect(fill="transparent", color="transparent")
   )
```

## Induction de variabilité
- Champignons générés "parfaitement proportionnés"
- Nécessité d'induire des variations (dispersion $\delta~$)

$$\left \{
\begin{array}{ll} 
L_{S} = L_{Smax}.F_{T}.\delta_{Ls} & \delta_{Ls} \sim \mathcal{N}(\mu = 1 ; \sigma = 0.05) \\
D_{S} = D_{Smax}.F_{T}.\delta_{Ds} & \delta_{Ds} \sim \mathcal{N}(\mu = 1 ; \sigma = 0.05) \\
D_{C} = D_{Cmax}.F_{T}.\delta_{Dc} & \delta_{Dc} \sim \mathcal{N}(\mu = 1 ; \sigma = 0.05) \\
\end{array}
\right.$$

## Induction de variabilité

```{r}
nuage3D_sansdispersion
```

## Induction de variabilité

```{r}
nuage3D_avecdispersion
```

# Classification binaire

## Algorithme de classification

1. Découpage lots d'entraînement/optimisation/évaluation,
2. Apprentissage sur lot d'entraînement,
3. Exploration de l'espace des hyperparamètres,
4. Mesure et modélisation des performances,
5. Sélection des meilleurs hyperparamètres,
6. Mesure de performance des meilleurs hyperparamètres,
7. Sélection des meilleurs modèles, évaluation finale.

## LDA

* Algorithme rapide ($t_{moy} =$ `r BI_temps_lda2` à `r BI_temps_pda` min)
* Performances prédictives insuffisantes ($J_{w} \approx `r round(mean(c(BI_fit_lda2_dim_resultats[,"Jw"], BI_fit_pda_lambda_resultats[,"Jw"])),3)`$)

```{r, dev = "png", dev.args=list(bg="transparent"), fig.height = 4.5, fig.cap = "Dix premiers facteurs de LDA prédisant la non-comestibilité des champignons"}
plot(BI_lda2_graphe_facteurs + 
   theme(
      panel.background = element_rect(fill = "transparent", color="transparent"),
      plot.background = element_rect(fill = "transparent", color="transparent"),
      legend.background = element_rect(fill="transparent", color="transparent"),
      legend.box.background = element_rect(fill="transparent", color="transparent")
   )
)
```

## Arbres décisionnels

```{r, dev = "png", dev.args=list(bg="transparent"), fig.height = 5.8, fig.cap = "Sensibilité (à g.) et spécificité (à d.) de rpartCost en fonction de la complexité et du coût"}
ggarrange(
   ncol = 2,
   BI_fit_rpartcost_sens_graphe + 
   theme(
      panel.background = element_rect(fill = "transparent", color="transparent"),
      plot.background = element_rect(fill = "transparent", color="transparent"),
      legend.background = element_rect(fill="transparent", color="transparent"),
      legend.box.background = element_rect(fill="transparent", color="transparent")
   ),
   BI_fit_rpartcost_spec_graphe + 
   theme(
      panel.background = element_rect(fill = "transparent", color="transparent"),
      plot.background = element_rect(fill = "transparent", color="transparent"),
      legend.background = element_rect(fill="transparent", color="transparent"),
      legend.box.background = element_rect(fill="transparent", color="transparent")
   )
)

```

## Arbres décisionnels

```{r, dev = "png", dev.args=list(bg="transparent"), fig.height = 5.8, fig.width = 6.5, fig.cap = "Indice de Youden pondéré de rpartCost en fonction de ses hyperparamètres"}
BI_fit_rpartcost_jw_graphe + 
   theme(legend.position='right') + 
   #theme(legend.text = element_text(angle = 0, vjust = 1, hjust = 0)) +
   theme(
      panel.background = element_rect(fill = "transparent", color="transparent"),
      plot.background = element_rect(fill = "transparent", color="transparent"),
      legend.background = element_rect(fill="transparent", color="transparent"),
      legend.box.background = element_rect(fill="transparent", color="transparent")
   )
```

## Arbres décisionnels
![Arbres simplifiés, optimisant la sensibilité (à g.) ou la spécificité (à d.)](BI_Arbre_Rpartcost_Duel.svg)

## Arbres décisionnels
![Structure arborescente complète](IntroChampisCART1Arbre.svg)

## Arbres décisionnels

* Arbres interprétables par l'humain,
* Performances prédictives et calculatoires correctes.
$$\left \{
\begin{array}{l}
J_{w_{Rpart}} = `r round(max(BI_fit_rpart_cp_resultats["Jw"]),4)` \\
J_{w_{RpartCost}} = `r round(BI_fit_rpartcost_best_resultats["Jw"],4)` \\
J_{w_{c5.0tree}} = `r round(BI_fit_c50tree_resultats["Jw"],4)` \\
\end{array}
\right.$$

## Forêts aléatoires

```{r, dev = "png", dev.args=list(bg="transparent"), fig.height = 5.8, fig.cap = "Sensibilité (à g.) et spécificité (à d.) du modèle Rborist"}
ggarrange(
   ncol = 2,
   BI_fit_Rborist_sens_graphe + 
      scale_fill_viridis_c(limits = c(0.999,1),option = "G", direction = 1) + 
      theme(
      panel.background = element_rect(fill = "transparent", color="transparent"),
      plot.background = element_rect(fill = "transparent", color="transparent"),
      legend.background = element_rect(fill="transparent", color="transparent"),
      legend.box.background = element_rect(fill="transparent", color="transparent")),
      BI_fit_Rborist_spec_graphe+ theme(
      panel.background = element_rect(fill = "transparent", color="transparent"),
      plot.background = element_rect(fill = "transparent", color="transparent"),
      legend.background = element_rect(fill="transparent", color="transparent"),
      legend.box.background = element_rect(fill="transparent", color="transparent")
   )
)
```

# Classification par espèces

## Arbres décisionnels


## Forêts aléatoires
